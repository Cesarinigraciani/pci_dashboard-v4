<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Mapa de Tareas</title>

<style>
body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #f3f4f6;
}

header {
    background: #ffffff;
    padding: 15px 20px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    gap: 15px;
}

header img {
    height: 50px;
}

header h1 {
    margin: 0;
    font-size: 22px;
    color: #111827;
}

.filtros {
    background: #ffffff;
    padding: 15px;
    display: flex;
    gap: 15px;
    align-items: center;
    border-bottom: 1px solid #d1d5db;
}

select {
    padding: 8px 12px;
    font-size: 15px;
    border-radius: 8px;
    border: 1px solid #9ca3af;
    background: #ffffff;
}

#planoContainer {
    position: relative;
    width: 100%;
    height: calc(100vh - 160px);
    overflow: auto;
    background: #e5e7eb;
}

#imgPlano {
    display: block;
    max-width: 100%;
    margin: 0 auto;
}

/* Marcadores */
.marker {
    position: absolute;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    border: 2px solid white;
    cursor: pointer;
    transform: translate(-50%, -50%);
}

/* Modal */
#modalTarea {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.7);
    display: none;
    justify-content: center;
    align-items: center;
}

.modal-content {
    background: #ffffff;
    padding: 20px;
    border-radius: 12px;
    width: 400px;
}

.modal-content h3 {
    margin-top: 0;
    color: #2563eb;
}

button {
    padding: 10px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    margin-top: 10px;
}

.btn-azul { background: #2563eb; color: white; }
.btn-rojo { background: #dc2626; color: white; }

.boton-volver {
    margin: 15px;
    padding: 10px 18px;
    background: #2563eb;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 15px;
    cursor: pointer;
}
</style>
</head>

<body>

<header>
    <img src="assets/img/logo-empresa.png" alt="Logo">
    <h1>Mapa de Tareas</h1>
</header>

<div class="filtros">
    <label><strong>Filtrar por estado:</strong></label>
    <select id="filtroEstado">
        <option value="todas">Todas</option>
        <option value="pendiente">Pendientes</option>
        <option value="proceso">En proceso</option>
        <option value="completada">Completadas</option>
        <option value="bloqueada">Bloqueadas</option>
    </select>
</div>

<div id="planoContainer">
    <img id="imgPlano" src="">
</div>

<button class="boton-volver" onclick="history.back()">⬅️ Volver</button>

<script src="scripts/usuarios.js"></script>
<script src="scripts/obras.js"></script>
<script src="scripts/tareas.js"></script>

<script>
let obraId = new URLSearchParams(window.location.search).get("obra");
let plantaId = new URLSearchParams(window.location.search).get("planta");
let planoId = new URLSearchParams(window.location.search).get("plano");

let planoActual = null;
let tareasPlano = [];

// Colores según estado
const colores = {
    pendiente: "#2563eb",
    proceso: "#f59e0b",
    completada: "#16a34a",
    bloqueada: "#dc2626"
};

/* ============================================================
   CARGAR PLANO Y TAREAS
============================================================ */
function cargarMapa() {
    const obra = getObraById(obraId);
    const planta = obra.plantas.find(p => p.id === plantaId);
    planoActual = planta.planos.find(pl => pl.id === planoId);

    document.getElementById("imgPlano").src = planoActual.imagen;

    const todasTareas = JSON.parse(localStorage.getItem("tareasPCI")) || [];
    tareasPlano = todasTareas.filter(t => t.planoId === planoId);

    renderMarcadores();
}

/* ============================================================
   MARCADORES EN EL PLANO
============================================================ */
function renderMarcadores() {
    const cont = document.getElementById("planoContainer");

    document.querySelectorAll(".marker").forEach(m => m.remove());

    const filtro = document.getElementById("filtroEstado").value;

    tareasPlano.forEach(t => {
        if (t.posX == null || t.posY == null) return;
        if (filtro !== "todas" && t.estado !== filtro) return;

        const mk = document.createElement("div");
        mk.className = "marker";
        mk.style.background = colores[t.estado] || "gray";

        mk.style.left = (t.posX * 100) + "%";
        mk.style.top = (t.posY * 100) + "%";

        mk.onclick = () => abrirModal(t);

        cont.appendChild(mk);
    });
}

/* ============================================================
   MODAL
============================================================ */
function abrirModal(t) {
    const modal = document.getElementById("modalTarea");
    modal.style.display = "flex";

    document.getElementById("modalTitulo").textContent = t.titulo;
    document.getElementById("modalDescripcion").textContent = t.descripcion;
    document.getElementById("modalEstado").textContent = t.estado;

    const responsable = usuariosData.find(u => u.id === t.asignadoA);
    document.getElementById("modalResponsable").textContent = responsable ? responsable.nombre : "—";

    document.getElementById("btnEditar").onclick = () => {
        window.location.href = "editar_tarea.html?id=" + t.id;
    };
}

function cerrarModal() {
    document.getElementById("modalTarea").style.display = "none";
}

document.getElementById("filtroEstado").addEventListener("change", renderMarcadores);

document.addEventListener("DOMContentLoaded", cargarMapa);
</script>

<!-- Modal -->
<div id="modalTarea">
    <div class="modal-content">
        <h3 id="modalTitulo"></h3>
        <p id="modalDescripcion"></p>
        <p><strong>Estado:</strong> <span id="modalEstado"></span></p>
        <p><strong>Responsable:</strong> <span id="modalResponsable"></span></p>

        <button class="btn-azul" id="btnEditar">Editar tarea</button>
        <button class="btn-rojo" onclick="cerrarModal()">Cerrar</button>
    </div>
</div>

</body>
</html>
