<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Crear Tarea</title>
    <link rel="stylesheet" href="styles/style-v2.css">

    <style>
        .form-card {
            max-width: 700px;
            margin: 40px auto;
            padding: 20px;
            background: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .form-card h2 {
            text-align: center;
            margin-bottom: 20px;
        }
        .form-card label {
            font-weight: bold;
            margin-top: 10px;
            display: block;
        }
        .form-card input, .form-card textarea, .form-card select {
            width: 100%;
            padding: 10px;
            margin-top: 6px;
            border-radius: 6px;
            border: 1px solid #ccc;
        }
        .btn-guardar {
            width: 100%;
            margin-top: 20px;
            padding: 12px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
        }
        .btn-volver {
            width: 100%;
            margin-top: 10px;
            padding: 12px;
            background: #0078d4;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
        }

        /* Modal plano */
        #modalPlano {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
        }
        #modalPlano img {
            max-width: 90%;
            max-height: 90%;
            border: 4px solid white;
            border-radius: 10px;
            cursor: crosshair;
        }
    </style>
</head>

<body>

<div class="form-card">
    <h2>Crear Nueva Tarea</h2>

    <label>Título de la tarea</label>
    <input type="text" id="tituloTarea">

    <label>Descripción</label>
    <textarea id="descripcionTarea" rows="4"></textarea>

    <label>Fecha de inicio</label>
    <input type="date" id="fechaInicioTarea">

    <label>Obra</label>
    <select id="selectObra"></select>

    <label>Planta</label>
    <select id="selectPlanta"></select>

    <label>Plano</label>
    <select id="selectPlano"></select>

    <button class="btn-guardar" onclick="abrirModalPlano()">Seleccionar ubicación en plano</button>

    <label>Asignada a</label>
    <select id="selectUsuarioAsignado"></select>

    <label>Estado inicial</label>
    <select id="estadoTarea">
        <option value="pendiente">Pendiente</option>
        <option value="proceso">En proceso</option>
        <option value="bloqueada">Bloqueada</option>
        <option value="completada">Completada</option>
    </select>
    <label>Prioridad</label>
    <select id="prioridadTarea">
    <option value="alta">Alta</option>
    <option value="media">Media</option>
    <option value="baja" selected>Baja</option>
</select>

    <button class="btn-guardar" onclick="guardarTarea()">Guardar Tarea</button>
    <button class="btn-volver" onclick="window.location.href='dashboard.html'">⬅️ Volver</button>
</div>

<!-- MODAL PARA SELECCIONAR POSICIÓN -->
<div id="modalPlano">
    <img id="imgPlanoSeleccion" src="">
</div>

<script src="scripts/usuarios.js"></script>
<script src="scripts/obras.js"></script>
<script src="scripts/tareas.js"></script>

<script>
let posX = null;
let posY = null;

/* ============================================================
   CARGAR OBRAS
============================================================ */
function cargarObras() {
    const obras = JSON.parse(localStorage.getItem("obrasPCI")) || [];
    const select = document.getElementById("selectObra");

    select.innerHTML = `<option value="">Seleccione una obra</option>`;

    obras.forEach(o => {
        const opt = document.createElement("option");
        opt.value = o.id;
        opt.textContent = o.nombre;
        select.appendChild(opt);
    });
}

/* ============================================================
   CARGAR PLANTAS SEGÚN OBRA
============================================================ */
function cargarPlantas() {
    const obraId = document.getElementById("selectObra").value;
    const obras = JSON.parse(localStorage.getItem("obrasPCI")) || [];
    const obra = obras.find(o => o.id === obraId);

    const select = document.getElementById("selectPlanta");
    select.innerHTML = "";

    if (!obra) return;

    obra.plantas.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = p.nombre;
        select.appendChild(opt);
    });

    cargarPlanos();
}

/* ============================================================
   CARGAR PLANOS SEGÚN PLANTA
============================================================ */
function cargarPlanos() {
    const obraId = document.getElementById("selectObra").value;
    const plantaId = document.getElementById("selectPlanta").value;

    const obras = JSON.parse(localStorage.getItem("obrasPCI")) || [];
    const obra = obras.find(o => o.id === obraId);
    const planta = obra?.plantas.find(p => p.id === plantaId);

    const select = document.getElementById("selectPlano");
    select.innerHTML = "";

    if (!planta || !planta.planos) return;

    planta.planos.forEach(pl => {
        const opt = document.createElement("option");
        opt.value = pl.id;
        opt.textContent = `${pl.disciplina} (${pl.id})`;
        select.appendChild(opt);
    });
}

/* ============================================================
   ABRIR MODAL PARA SELECCIONAR POSICIÓN
============================================================ */
function abrirModalPlano() {
    const obraId = document.getElementById("selectObra").value;
    const plantaId = document.getElementById("selectPlanta").value;
    const planoId = document.getElementById("selectPlano").value;

    if (!obraId || !plantaId || !planoId) {
        alert("Debe seleccionar obra, planta y plano.");
        return;
    }

    const obras = JSON.parse(localStorage.getItem("obrasPCI")) || [];
    const obra = obras.find(o => o.id === obraId);
    const planta = obra.plantas.find(p => p.id === plantaId);
    const plano = planta.planos.find(pl => pl.id === planoId);

    const modal = document.getElementById("modalPlano");
    const img = document.getElementById("imgPlanoSeleccion");

    img.src = plano.imagen;
    modal.style.display = "flex";

    img.onclick = function(e) {
        const rect = img.getBoundingClientRect();
        posX = (e.clientX - rect.left) / rect.width;
        posY = (e.clientY - rect.top) / rect.height;

        alert("Ubicación seleccionada correctamente.");
        modal.style.display = "none";
    };
}

/* ============================================================
   CARGAR USUARIOS
============================================================ */
function cargarUsuariosAsignables() {
    const usuarios = usuariosData;
    const select = document.getElementById("selectUsuarioAsignado");

    select.innerHTML = "";

    usuarios.forEach(u => {
        const option = document.createElement("option");
        option.value = u.id;
        option.textContent = u.nombre;
        select.appendChild(option);
    });

    const actual = getUsuarioActual();
    if (actual) select.value = actual.id;
}

/* ============================================================
   GUARDAR TAREA
============================================================ */
function guardarTarea() {
    const titulo = document.getElementById("tituloTarea").value.trim();
    const descripcion = document.getElementById("descripcionTarea").value.trim();
    const fechaInicio = document.getElementById("fechaInicioTarea").value;
    const obraId = document.getElementById("selectObra").value;
    const plantaId = document.getElementById("selectPlanta").value;
    const planoId = document.getElementById("selectPlano").value;
    const asignadoA = document.getElementById("selectUsuarioAsignado").value;
    const estado = document.getElementById("estadoTarea").value;
    const prioridad = document.getElementById("prioridadTarea").value;

    if (!titulo || !descripcion) {
        alert("El título y la descripción son obligatorios.");
        return;
    }

    if (!obraId || !plantaId || !planoId) {
        alert("Debe seleccionar obra, planta y plano.");
        return;
    }

    if (posX === null || posY === null) {
        alert("Debe seleccionar una ubicación en el plano.");
        return;
    }

    const creador = getUsuarioActual();

    crearTarea({
        titulo,
        descripcion,
        obraId,
        plantaId,
        planoId,
        posX,
        posY,
        asignadoA,
        estado,
        prioridad, // ← AQUI
        creadoPor: creador.id,
        fechaInicio
    });

    alert("Tarea creada correctamente.");
    window.location.href = "dashboard.html";
}

/* ============================================================
   INICIALIZACIÓN
============================================================ */
document.addEventListener("DOMContentLoaded", () => {
    cargarObras();
    cargarUsuariosAsignables();

    const params = new URLSearchParams(window.location.search);
    const obraId = params.get("obra");

    if (obraId) {
        document.getElementById("selectObra").value = obraId;
        cargarPlantas();

        // Seleccionar automáticamente la primera planta
        const plantas = document.getElementById("selectPlanta");
        if (plantas.options.length > 0) {
            plantas.selectedIndex = 0;
            cargarPlanos();

            // Seleccionar automáticamente el primer plano
            const planos = document.getElementById("selectPlano");
            if (planos.options.length > 0) {
                planos.selectedIndex = 0;
            }
        }
    }

    document.getElementById("selectObra").addEventListener("change", cargarPlantas);
    document.getElementById("selectPlanta").addEventListener("change", cargarPlanos);
});

</script>

</body>
</html>
